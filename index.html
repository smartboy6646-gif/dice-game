<!DOCTYPE html>
<html lang="ne">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shut the Box - Ultra Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root { --p1: #ff4757; --p2: #f1c40f; --bg: #0f0f0f; --hard: #9b59b6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; text-align: center; margin: 0; overflow: hidden; touch-action: manipulation; }
        
        #login-screen { position: fixed; inset: 0; background: var(--bg); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        input { padding: 15px; margin: 10px; width: 80%; max-width: 300px; border-radius: 10px; border: none; font-size: 16px; background: #222; color: #fff; border: 1px solid #444; }

        .board { display: flex; flex-direction: column; justify-content: space-between; height: 100vh; padding: 5px; box-sizing: border-box; }
        
        /* Player Header */
        .player-info { font-size: 1.2rem; font-weight: bold; padding: 5px; transition: 0.3s; color: #555; }
        .p1-name.active { color: var(--p1); text-shadow: 0 0 10px var(--p1); }
        .p2-name.active { color: var(--p2); text-shadow: 0 0 10px var(--p2); }

        .card-row { 
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; 
            max-width: 400px; margin: 0 auto; padding: 10px; border-radius: 15px; 
            transition: 0.5s; border: 2px solid transparent;
        }
        
        /* Turn Glows */
        .glow-p1 { border-color: var(--p1); box-shadow: 0 0 20px rgba(255, 71, 87, 0.3); background: rgba(255, 71, 87, 0.05); }
        .glow-p2 { border-color: var(--p2); box-shadow: 0 0 20px rgba(241, 196, 15, 0.3); background: rgba(241, 196, 15, 0.05); }
        .hard-glow { border: 2px dashed var(--hard) !important; box-shadow: 0 0 25px var(--hard) !important; }

        .card { height: 65px; background: #fff; color: #000; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px; box-shadow: 0 4px #bbb; }
        .p1 .card { background: var(--p1); color: white; }
        .p2 .card { background: var(--p2); color: #000; }
        .shut { opacity: 0.05 !important; transform: scale(0.85); pointer-events: none; }
        .selected { transform: translateY(-8px); border: 2px solid #fff; box-shadow: 0 0 10px #fff; }

        .dice { display: inline-block; width: 60px; height: 60px; background: white; color: black; border-radius: 12px; font-size: 40px; line-height: 60px; margin: 5px; box-shadow: 0 5px #ddd; }
        .rolling { animation: shake 0.1s infinite; }
        @keyframes shake { 0% { transform: rotate(5deg); } 50% { transform: rotate(-5deg); } 100% { transform: rotate(5deg); } }

        #hard-mode-btn { background: #333; color: #777; padding: 6px 15px; border-radius: 20px; border: 1px solid #555; font-size: 11px; cursor: pointer; }
        #hard-mode-btn.active { background: var(--hard); color: white; border-color: #fff; }

        #roll-btn { background: #3498db; color: white; padding: 12px 40px; border-radius: 40px; border: none; font-size: 18px; font-weight: bold; }
        #roll-btn:disabled { opacity: 0.2; }

        #win-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 200; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="login-screen">
    <h2 style="color:var(--p1)">üé≤ Shut the Box</h2>
    <input type="text" id="user-name" placeholder="Tapaiko Name">
    <input type="text" id="room-id" placeholder="Room ID">
    <button onclick="joinGame()" style="padding:15px 40px; background:#2ecc71; border:none; border-radius:10px; color:white; font-weight:bold;">KHELNAI SURU</button>
</div>

<div id="win-overlay">
    <h1 id="winner-name" style="color:#00ff00; font-size: 3rem;">WINNER!</h1>
    <button onclick="resetRoomAfterWin()" style="padding:15px 30px; background:white; border-radius:10px; border:none; font-weight:bold;">NEW GAME</button>
</div>

<div class="board">
    <div>
        <div id="p2-label" class="player-info p2-name">Player 2</div>
        <div id="p2-area" class="card-row p2"></div>
    </div>

    <div class="center-ui">
        <button id="hard-mode-btn" onclick="toggleHardMode()">HARD MODE: OFF</button>
        <div id="status" style="font-size:0.9rem; color:#2ecc71; margin: 5px 0; min-height:35px;">Connecting...</div>
        <div id="dice-box">
            <div id="d1" class="dice">‚öÄ</div>
            <div id="d2" class="dice">‚öÄ</div>
        </div>
        <p style="margin:2px;">Target: <b id="target">0</b> | Sum: <b id="sum">0</b></p>
        <button id="roll-btn" onclick="roll()">ROLL</button>
    </div>

    <div>
        <div id="p1-area" class="card-row p1"></div>
        <div id="p1-label" class="player-info p1-name">Player 1</div>
    </div>
</div>

<audio id="dice-sound" src="https://www.soundjay.com/board-games/sounds/dice-roll-1.mp3"></audio>

<script>
    const firebaseConfig = { apiKey: "AIzaSyDT6QJyFjZhjrCd-7d00IxFSlWqOBp2xY8",
  authDomain: "poison-and-save.firebaseapp.com",
  databaseURL: "https://poison-and-save-default-rtdb.firebaseio.com",
  projectId: "poison-and-save",
  storageBucket: "poison-and-save.firebasestorage.app",
  messagingSenderId: "475847800468",
  appId: "1:475847800468:web:93605c30c6c6c775e2a681",
  measurementId: "G-VR6WKKB1DV" };
    firebase.initializeApp(firebaseConfig);
    let db, myRole, roomID, myName;
    const emojis = ['‚öÄ','‚öÅ','‚öÇ','‚öÉ','‚öÑ','‚öÖ'];

    function joinGame() {
        myName = document.getElementById('user-name').value || "Guest";
        roomID = document.getElementById('room-id').value;
        if(!roomID) return alert("Room ID chahinchha!");
        
        db = firebase.database().ref('rooms/' + roomID);
        document.getElementById('login-screen').style.display = 'none';

        db.child('players_count').transaction(c => (c || 0) + 1, (err, committed, snap) => {
            myRole = snap.val();
            if(myRole === 1) db.update({ gameStarted: false, hardMode: false, p1_name: myName, p1_shut: "", p2_shut: "", toss_p1: 0, toss_p2: 0, d1: 1, d2: 1 });
            else if(myRole === 2) db.update({ p2_name: myName });
            initGame();
        });
        db.child('players_count').onDisconnect().transaction(c => (c > 0 ? c - 1 : 0));
    }

    function toggleHardMode() {
        db.once('value', s => {
            if(s.val().gameStarted) return;
            db.update({ hardMode: !s.val().hardMode });
        });
    }

    function initGame() {
        const rows = [document.getElementById('p1-area'), document.getElementById('p2-area')];
        rows.forEach((row, p) => {
            row.innerHTML = '';
            for(let i=1; i<=10; i++) row.innerHTML += `<div class="card" id="p${p+1}-c-${i}" onclick="selectCard(${p+1}, ${i})">${i}</div>`;
        });
        db.on('value', snap => handleGameState(snap.val() || {}));
    }

    function handleGameState(data) {
        const rollBtn = document.getElementById('roll-btn');
        const hmBtn = document.getElementById('hard-mode-btn');
        
        // Names & Labels
        document.getElementById('p1-label').innerText = data.p1_name || "Player 1";
        document.getElementById('p2-label').innerText = data.p2_name || "Player 2";
        
        hmBtn.innerText = data.hardMode ? "HARD MODE: ON üî•" : "HARD MODE: OFF";
        data.hardMode ? hmBtn.classList.add('active') : hmBtn.classList.remove('active');

        if((data.players_count || 0) < 2) {
            document.getElementById('status').innerText = "Waiting for P2 to join...";
            rollBtn.disabled = true; return;
        }

        // TOSS PHASE
        if(!data.gameStarted) {
            const p1 = data.toss_p1 || 0, p2 = data.toss_p2 || 0;
            document.getElementById('d1').innerText = emojis[(data.d1 || 1)-1];
            document.getElementById('d2').innerText = emojis[(data.d2 || 1)-1];

            if(p1 === 0 && p2 === 0) {
                document.getElementById('status').innerHTML = "TOSS: Player 1 Roll!";
                rollBtn.disabled = (myRole !== 1);
            } else if(p1 > 0 && p2 === 0) {
                document.getElementById('status').innerHTML = `P1 ‡§≤‡•á ${p1} ‡§≤‡•ç‡§Ø‡§æ‡§Ø‡•ã!<br>Aba P2 ko palo`;
                rollBtn.disabled = (myRole !== 2);
            } else if(p1 > 0 && p2 > 0) {
                if(p1 === p2) {
                    document.getElementById('status').innerText = "DRAW! Re-tossing...";
                    if(myRole === 1) setTimeout(() => db.update({ toss_p1: 0, toss_p2: 0 }), 1500);
                } else {
                    const starter = p1 > p2 ? 1 : 2;
                    document.getElementById('status').innerText = `P1: ${p1} | P2: ${p2} -> P${starter} Starts!`;
                    if(myRole === 1) setTimeout(() => db.update({ gameStarted: true, turn: starter, d1:1, d2:1 }), 2000);
                }
            }
            return;
        }

        // GAME PHASE
        const turn = data.turn;
        const isMyTurn = turn === myRole;
        document.getElementById('status').innerText = isMyTurn ? "TAPAI KO PALO!" : "Opponent Turn...";
        rollBtn.disabled = !isMyTurn || data.target > 0;

        // NAME & ROW GLOW FIX
        document.getElementById('p1-label').className = "player-info p1-name " + (turn === 1 ? "active" : "");
        document.getElementById('p2-label').className = "player-info p2-name " + (turn === 2 ? "active" : "");
        
        document.getElementById('p1-area').className = `card-row p1 ${turn === 1 ? (data.hardMode ? 'glow-p1 hard-glow' : 'glow-p1') : ''}`;
        document.getElementById('p2-area').className = `card-row p2 ${turn === 2 ? (data.hardMode ? 'glow-p2 hard-glow' : 'glow-p2') : ''}`;

        document.getElementById('d1').innerText = emojis[(data.d1 || 1)-1];
        document.getElementById('d2').innerText = emojis[(data.d2 || 1)-1];
        document.getElementById('target').innerText = data.target;

        [1,2].forEach(p => {
            const shutArr = (data[`p${p}_shut`] || "").split(',').filter(x => x);
            if(shutArr.length === 10) {
                document.getElementById('win-overlay').style.display = 'flex';
                document.getElementById('winner-name').innerText = (data[`p${p}_name`] || "Player "+p) + " WINS!";
            }
            for(let i=1; i<=10; i++) {
                const el = document.getElementById(`p${p}-c-${i}`);
                el.classList.toggle('shut', shutArr.includes(i.toString()));
                el.classList.remove('selected');
            }
        });

        if(isMyTurn && data.target > 0) checkPass(data);
    }

    function roll() {
        document.getElementById('dice-sound').play();
        const d1 = document.getElementById('d1'), d2 = document.getElementById('d2');
        d1.classList.add('rolling'); d2.classList.add('rolling');
        
        setTimeout(() => {
            const v1 = Math.floor(Math.random() * 6) + 1;
            const v2 = Math.floor(Math.random() * 6) + 1;
            db.once('value', s => {
                const data = s.val();
                if(!data.gameStarted) db.update({ [`toss_p${myRole}`]: v1+v2, d1: v1, d2: v2 });
                else db.update({ d1: v1, d2: v2, target: v1+v2 });
                d1.classList.remove('rolling'); d2.classList.remove('rolling');
            });
        }, 800);
    }

    function selectCard(p, n) {
        if(p !== myRole) return;
        const el = document.getElementById(`p${p}-c-${n}`);
        if(el.classList.contains('shut')) return;
        el.classList.toggle('selected');
        let sum = 0, nums = [];
        document.querySelectorAll(`.p${myRole} .selected`).forEach(c => { sum += parseInt(c.innerText); nums.push(c.innerText); });
        document.getElementById('sum').innerText = sum;
        db.once('value', s => { if(sum === s.val().target && s.val().target > 0) finalizeMove(nums); });
    }

    function finalizeMove(nums) {
        db.once('value', s => {
            const data = s.val();
            const old = (data[`p${myRole}_shut`] || "").split(',').filter(x => x);
            const updates = { [`p${myRole}_shut`]: [...old, ...nums].join(','), target: 0 };
            if (!data.hardMode) updates.turn = (myRole === 1 ? 2 : 1);
            db.update(updates);
            document.getElementById('sum').innerText = "0";
        });
    }

    function checkPass(data) {
        let avail = [];
        for(let i=1; i<=10; i++) if(!document.getElementById(`p${myRole}-c-${i}`).classList.contains('shut')) avail.push(i);
        const canWork = (arr, n, target) => {
            if (target == 0) return true;
            if (n == 0) return false;
            if (arr[n - 1] > target) return canWork(arr, n - 1, target);
            return canWork(arr, n - 1, target) || canWork(arr, n - 1, target - arr[n - 1]);
        };
        if(!canWork(avail, avail.length, data.target)) {
            document.getElementById('status').innerText = data.hardMode ? "HARD FAIL! RESETTING..." : "No moves! Passing...";
            setTimeout(() => {
                let up = { target: 0, turn: (myRole === 1 ? 2 : 1) };
                if(data.hardMode) up[`p${myRole}_shut`] = ""; 
                db.update(up);
            }, 1000);
        }
    }

    function resetRoomAfterWin() {
        db.update({ gameStarted: false, p1_shut: "", p2_shut: "", target: 0, toss_p1: 0, toss_p2: 0 }).then(() => location.reload());
    }
</script>
</body>
</html>
